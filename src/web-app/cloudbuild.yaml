steps:
### [BUILD APP] ###
  # Install dependencies
  - name: python:3.9.2
    id: list-working-directory
    entrypoint: 'bash'
    dir: 'src/web-app'
    args: ['-c', 'pwd && ls -alh']

  - name: python:3.9.2
    id: install-dependencies
    entrypoint: pip
    dir: 'src/web-app'
    args: ["install", "-r", "requirements.txt", "--user"]

  # Run unit tests against app
  - name: python:3.9.2
    id: unit-test-application
    entrypoint: 'bash'
    dir: 'src/web-app'
    args: ['-c', 'MYSQL_DATABASE_PASSWORD=$$WEB_APP_DB_PASSWORD DB_HOST=$$DB_HOST python -m pytest']
    secretEnv: ['WEB_APP_DB_PASSWORD']
    env:
      - 'DB_HOST=34.73.152.50'

### [BUILD CONTAINER] ###
  - name: 'gcr.io/cloud-builders/docker'
    id: build-app-container-image
    dir: 'src/web-app'
    args: ['build', '-t', 'gcr.io/${PROJECT_ID}/web-app:${_APP_VERSION}', '.']

### [SCAN CONTAINER] ###
  - name: gcr.io/cloud-builders/docker
    id: inspect-container
    entrypoint: /bin/bash
    dir: 'src/web-app'
    args:
    - -c
    - |
      docker image inspect gcr.io/${PROJECT_ID}/web-app:${_APP_VERSION} --format \
        '{{index .RepoTags 0}}@{{.Id}}' > /workspace/image-digest.txt
      cat image-digest.txt
   
  - name: gcr.io/cloud-builders/gcloud
    id: vulnerability-scan-container
    entrypoint: /bin/bash
    dir: 'src/web-app'
    args:
    - -c
    - |
      gcloud artifacts docker images scan gcr.io/${PROJECT_ID}/web-app:${_APP_VERSION} \
      --format='value(response.scan)' > /workspace/scan_id.txt

  - name: gcr.io/cloud-builders/gcloud
    id: vulnerability-severity-check
    entrypoint: /bin/bash
    dir: 'src/web-app'
    args:
    - -c
    - | # Check the vulnerabilities and exit if it meets severity level
      gcloud artifacts docker images list-vulnerabilities \
       $(cat /workspace/scan_id.txt) --format='value(vulnerability.effectiveSeverity)' \
       | if grep -Fxq $_SEVERITY 
         then echo 'Failed vulnerability check'
         exit 1 
         fi

### [PUBLISH APP] ###
images: ['gcr.io/${PROJECT_ID}/web-app:${_APP_VERSION}']

availableSecrets:
  secretManager:
  - versionName: projects/791112449288/secrets/WEB_APP_DB_PASSWORD/versions/1
    env: 'WEB_APP_DB_PASSWORD'

substitutions:
    _APP_VERSION: 0.1.12
